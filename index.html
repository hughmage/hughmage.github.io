<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora NEM y Simulador PAES</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #3498db;
    --primary-dark: #2980b9;
    --secondary: #2ecc71;
    --dark: #2c3e50;
    --light: #ecf0f1;
    --gray: #95a5a6;
    --danger: #e74c3c;
    --warning: #f39c12;
    --success: #27ae60;
    --bg: #f5f7fa;
    --text: #2c3e50;
    --card-bg: white;
    --border: #eee;
    --input-bg: white;
  }

  /* Dark Mode */
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #1a1a1a;
      --text: #ecf0f1;
      --card-bg: #2c3e50;
      --border: #3d566e;
      --input-bg: #34495e;
      --dark: #ecf0f1;
      --light: #2c3e50;
    }
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--bg);
    color: var(--text);
    line-height: 1.6;
    transition: all 0.3s ease;
  }
  
  .container {
    max-width: 700px;
    margin: 30px auto;
    padding: 20px;
    background: var(--card-bg);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }
  
  header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }
  
  h1 { color: var(--primary); font-weight: 600; margin-bottom: 10px; }
  .subtitle { color: var(--gray); font-weight: 300; font-size: 1rem; }
  .form-group { margin-bottom: 20px; animation: fadeIn 0.5s ease; }
  label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); }
  
  select, input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background-color: var(--input-bg);
    color: var(--text);
  }
  
  select:focus, input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
  }

  input.valid {
    border-color: var(--success);
    background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2327ae60' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 6L9 17l-5-5'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 20px;
    padding-right: 35px;
  }

  input.invalid {
    border-color: var(--danger);
    background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23e74c3c' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cline x1='12' y1='8' x2='12' y2='12'/%3E%3Cline x1='12' y1='16' x2='12.01' y2='16'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 20px;
    padding-right: 35px;
  }
  
  .input-group { display: flex; gap: 15px; }
  .input-item { flex: 1; }
  .help-link { font-size: 0.85rem; color: var(--primary); text-decoration: none; display: inline-flex; align-items: center; margin-top: 5px; transition: all 0.2s ease; }
  .help-link:hover { text-decoration: underline; transform: translateX(2px); }
  .help-link svg { margin-right: 5px; }
  
  button {
    width: 100%;
    padding: 14px;
    background-color: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  button:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3); }
  button:active { transform: translateY(0); }
  button.secondary { background-color: var(--gray); margin-top: 10px; }
  button.secondary:hover { background-color: #7f8c8d; box-shadow: 0 5px 15px rgba(149, 165, 166, 0.3); }
  
  #resultado, #resultado-simulador { margin-top: 30px; padding: 20px; background-color: var(--light); border-radius: 8px; border-left: 4px solid var(--primary); display: none; animation: fadeIn 0.5s ease; }
  .result-title { color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
  .result-item { margin-bottom: 12px; display: flex; justify-content: space-between; }
  .result-label { font-weight: 500; color: var(--dark); }
  .result-value { font-weight: 600; color: var(--dark); }
  .notas-container { background-color: var(--card-bg); padding: 15px; border-radius: 8px; margin: 15px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  .notas-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .nota-item { display: flex; justify-content: space-between; animation: slideIn 0.3s ease; }
  .promedio-box { background-color: var(--primary); color: white; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; animation: fadeIn 0.5s ease; }
  .puntaje-box { background-color: var(--success); color: white; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; font-size: 1.2rem; font-weight: 600; animation: fadeIn 0.6s ease; }
  .error-message { color: var(--danger); font-size: 0.9rem; margin-top: 5px; display: none; animation: fadeIn 0.3s ease; }
  .info-box { background-color: var(--light); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; border-left: 4px solid var(--primary); animation: fadeIn 0.4s ease; }
  .section-title { color: var(--primary); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
  
  .spinner {
    display: none;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
    margin-right: 8px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }

  .main-tab-buttons { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 25px; }
  .main-tab-button {
    flex: 1; padding: 15px; background: none; border: none; cursor: pointer;
    font-weight: 600; font-size: 1.1rem; color: var(--gray);
    border-bottom: 4px solid transparent; transition: all 0.3s ease;
    margin: 0; width: auto;
  }
  .main-tab-button.active { color: var(--primary); border-bottom-color: var(--primary); }
  .main-tab-content { display: none; }
  .main-tab-content.active { display: block; animation: fadeIn 0.6s ease; }

  .ponderacion-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
  .score-input-group { display: flex; align-items: center; gap: 10px; }
  .score-input-group label { margin-bottom: 0; flex: 1; }
  .score-input-group input { flex: 0 0 120px; }
  .ponderacion-info { font-size: 0.8rem; color: var(--gray); text-align: right; margin-top: 4px; height: 1em; }
  #resultado-simulador .result-value { font-size: 1.4rem; }
  #resultado-simulador .corte-info { font-size: 1rem; text-align: center; margin: 15px 0; }
  #resultado-simulador .diferencia { font-weight: 600; }
  .diferencia.positiva { color: var(--success); }
  .diferencia.negativa { color: var(--danger); }

  .info-section {
    margin-top: 40px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
  }
  .info-section h2 {
    color: var(--primary);
    margin-bottom: 20px;
  }
  .faq-item {
    margin-bottom: 15px;
  }
  .faq-item h3 {
    font-weight: 500;
    color: var(--dark);
  }
  .faq-item p {
    margin-top: 5px;
    padding-left: 10px;
    border-left: 2px solid var(--primary-light);
  }
  .useful-links-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
  }
  .useful-link {
    display: flex;
    align-items: center;
    padding: 15px;
    background-color: var(--light);
    border-radius: 8px;
    text-decoration: none;
    color: var(--text);
    transition: all 0.3s ease;
    font-weight: 500;
  }
  .useful-link:hover {
    background-color: var(--primary);
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  .useful-link svg {
    margin-left: auto;
    stroke: currentColor;
  }
  .about-section {
    text-align: center;
    margin-top: 40px;
    padding: 20px;
    background-color: var(--light);
    border-radius: 8px;
    font-style: italic;
    color: var(--gray);
  }

  @media (max-width: 480px) {
    .container { margin: 15px; padding: 15px; }
    .input-group, .ponderacion-grid { flex-direction: column; gap: 15px; }
    .score-input-group { flex-wrap: wrap; }
    .score-input-group input { flex-grow: 1; }
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Calculadora y Simulador PAES</h1>
    <p class="subtitle">Calcula tu NEM y simula tu puntaje ponderado para la carrera de tus sueños</p>
  </header>

  <div class="main-tab-buttons">
    <button class="main-tab-button active" data-tab="calculadora-nem">Calculadora NEM</button>
    <button class="main-tab-button" data-tab="simulador-paes">Simulador PAES</button>
  </div>

  <div class="main-tab-content active" id="calculadora-nem">
    <div class="info-box">
      Esta calculadora te permite transformar tu promedio de notas de enseñanza media (NEM) al puntaje estándar utilizado en el proceso de admisión.
    </div>
    
    <div class="form-group">
      <label for="grupo">Grupo de dependencia</label>
      <select id="grupo">
        <option value="">-- Selecciona tu grupo --</option>
        <option value="A">Grupo A - Enseñanza Media Humanístico-Científica</option>
        <option value="B">Grupo B - Enseñanza Media Humanístico-Científica de adultos</option>
        <option value="C">Grupo C - Enseñanza Media Técnico Profesional</option>
      </select>
      <a href="https://demre.cl/paes/factores-seleccion/tabla-transformacion-nem" target="_blank" class="help-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
        No sé cuál es mi grupo
      </a>
      <div id="grupo-error" class="error-message">Por favor, selecciona un grupo</div>
    </div>
    
    <div class="form-group">
      <label>Ingresa tus notas de enseñanza media</label>
      <div class="input-group">
        <div class="input-item"><label for="nem1">1° Medio</label><input type="text" id="nem1" placeholder="Ej: 5,8" inputmode="decimal"><div id="nem1-error" class="error-message">Nota inválida (1.0 - 7.0)</div></div>
        <div class="input-item"><label for="nem2">2° Medio</label><input type="text" id="nem2" placeholder="Ej: 6,2" inputmode="decimal"><div id="nem2-error" class="error-message">Nota inválida (1.0 - 7.0)</div></div>
      </div>
      <div class="input-group" style="margin-top:15px;">
        <div class="input-item"><label for="nem3">3° Medio</label><input type="text" id="nem3" placeholder="Ej: 6,5" inputmode="decimal"><div id="nem3-error" class="error-message">Nota inválida (1.0 - 7.0)</div></div>
        <div class="input-item"><label for="nem4">4° Medio</label><input type="text" id="nem4" placeholder="Ej: 6,7" inputmode="decimal"><div id="nem4-error" class="error-message">Nota inválida (1.0 - 7.0)</div></div>
      </div>
    </div>
    
    <button id="calcular-btn">
      <div class="spinner" id="calc-spinner"></div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
      Calcular Puntaje NEM
    </button>
    <button id="limpiar-btn" class="secondary">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
      Limpiar Formulario
    </button>
    
    <div id="resultado">
      <h3 class="result-title"><span>Resultados NEM</span><span id="grupo-resultado" style="font-size: 0.9rem; font-weight: 400;"></span></h3>
      <div class="notas-container">
        <div class="notas-grid">
          <div class="nota-item"><span class="result-label">1° Medio:</span><span class="result-value" id="show-nem1"></span></div>
          <div class="nota-item"><span class="result-label">2° Medio:</span><span class="result-value" id="show-nem2"></span></div>
          <div class="nota-item"><span class="result-label">3° Medio:</span><span class="result-value" id="show-nem3"></span></div>
          <div class="nota-item"><span class="result-label">4° Medio:</span><span class="result-value" id="show-nem4"></span></div>
        </div>
      </div>
      <div class="promedio-box"><div class="result-item"><span>Promedio NEM:</span><span id="promedio-nem" style="font-weight: 600;"></span></div></div>
      <div class="puntaje-box"><div class="result-item"><span>Puntaje NEM:</span><span id="puntaje-nem" style="font-size: 1.4rem;"></span></div></div>
    </div>
  </div>

  <div class="main-tab-content" id="simulador-paes">
    <div class="info-box">
      Selecciona una carrera, ingresa tus puntajes estimados y descubre cómo te posicionas respecto al puntaje de corte del último proceso de admisión.
    </div>
    
    <div class="form-group">
      <label for="universidad">Universidad</label>
      <select id="universidad"><option value="">-- Cargando universidades... --</option></select>
    </div>

    <div class="form-group">
      <label for="carrera">Carrera</label>
      <select id="carrera" disabled><option value="">-- Selecciona una universidad primero --</option></select>
    </div>

    <div class="form-group">
      <label>Ingresa tus puntajes PAES (100 - 1000)</label>
      <div class="ponderacion-grid">
        <div class="input-item">
          <div class="score-input-group">
            <label for="p-nem">Puntaje NEM</label>
            <input type="number" id="p-nem" placeholder="100-1000">
          </div>
          <div class="ponderacion-info" id="w-nem"></div>
        </div>
        <div class="input-item">
          <div class="score-input-group">
            <label for="p-ranking">Ranking</label>
            <input type="number" id="p-ranking" placeholder="100-1000">
          </div>
          <div class="ponderacion-info" id="w-ranking"></div>
        </div>
        <div class="input-item">
          <div class="score-input-group">
            <label for="p-lectora">C. Lectora</label>
            <input type="number" id="p-lectora" placeholder="100-1000">
          </div>
          <div class="ponderacion-info" id="w-lectora"></div>
        </div>
        <div class="input-item">
          <div class="score-input-group">
            <label for="p-m1">Matemática M1</label>
            <input type="number" id="p-m1" placeholder="100-1000">
          </div>
          <div class="ponderacion-info" id="w-m1"></div>
        </div>
        <div class="input-item">
          <div class="score-input-group">
            <label for="p-m2">Matemática M2</label>
            <input type="number" id="p-m2" placeholder="100-1000">
          </div>
          <div class="ponderacion-info" id="w-m2"></div>
        </div>
        <div class="input-item">
          <div class="score-input-group">
            <label for="p-ciencias">Ciencias</label>
            <input type="number" id="p-ciencias" placeholder="100-1000">
          </div>
          <div class="ponderacion-info" id="w-ciencias"></div>
        </div>
         <div class="input-item">
          <div class="score-input-group">
            <label for="p-historia">Historia</label>
            <input type="number" id="p-historia" placeholder="100-1000">
          </div>
          <div class="ponderacion-info" id="w-historia"></div>
        </div>
      </div>
    </div>
    <button id="simular-btn">
       <div class="spinner" id="sim-spinner"></div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><path d="M12 20V10"></path><path d="M18 20V4"></path><path d="M6 20V16"></path></svg>
      Simular Puntaje
    </button>

     <div id="resultado-simulador">
        <h3 class="result-title"><span>Resultado de la Simulación</span></h3>
        <div class="puntaje-box">
            <div class="result-item">
                <span>Tu Puntaje Ponderado:</span>
                <span id="puntaje-ponderado" class="result-value"></span>
            </div>
        </div>
        <div class="corte-info">
            Puntaje de Corte 2025: <strong id="puntaje-corte"></strong>
        </div>
        <div class="promedio-box">
            <div class="result-item">
                <span>Diferencia con el corte:</span>
                <span id="diferencia-puntaje" class="diferencia"></span>
            </div>
        </div>
    </div>
  </div>

  <div class="info-section">
    <h2>Preguntas Frecuentes</h2>
    <div class="faq-item">
      <h3>¿Qué es el NEM?</h3>
      <p>El NEM (Notas de Enseñanza Media) es un factor de selección utilizado en el proceso de admisión a las universidades chilenas. Corresponde al promedio de tus notas de 1° a 4° medio, transformado a un puntaje estándar que va desde 100 hasta 1000 puntos.</p>
    </div>
    <div class="faq-item">
      <h3>¿Cómo se calcula el puntaje NEM?</h3>
      <p>El cálculo del puntaje NEM se realiza en 3 pasos: Se calcula el promedio simple de tus notas de 1° a 4° medio. Este promedio se redondea a 2 decimales. Según tu grupo de dependencia (A, B o C), se busca en la tabla de transformación del DEMRE el puntaje correspondiente a tu promedio.</p>
    </div>
    <div class="faq-item">
      <h3>Importancia del NEM</h3>
      <p>El puntaje NEM es uno de los componentes principales del puntaje de selección a la universidad, junto con el puntaje de la PAES (Prueba de Acceso a la Educación Superior). Dependiendo de la carrera y universidad, el NEM puede representar entre el 10% y el 40% de tu puntaje final.</p>
    </div>
    <div class="faq-item">
      <h3>¿Qué grupo de dependencia debo seleccionar?</h3>
      <p>Debes seleccionar según el tipo de establecimiento donde cursaste tu enseñanza media: Grupo A: Enseñanza Media Humanístico-Científica regular (colegios científicos-humanistas diurnos). Grupo B: Enseñanza Media Humanístico-Científica de adultos (colegios nocturnos o de adultos). Grupo C: Enseñanza Media Técnico-Profesional (liceos técnicos).</p>
    </div>
    <div class="faq-item">
        <h3>¿Qué pasa si repetí un año?</h3>
        <p>Para el cálculo del NEM solo se consideran las notas del último año cursado en cada nivel. Si repetiste 2° medio, por ejemplo, solo se considerarán las notas de la segunda vez que lo cursaste.</p>
    </div>
    <div class="faq-item">
        <h3>¿Cómo afecta el NEM a mi postulación?</h3>
        <p>El NEM es uno de los componentes de tu puntaje ponderado. Cada universidad y carrera asigna un porcentaje distinto al NEM en su ponderación, por lo que su importancia varía según tu elección de carrera.</p>
    </div>
    <div class="faq-item">
        <h3>¿Puedo mejorar mi puntaje NEM?</h3>
        <p>El NEM se calcula con tus notas definitivas de enseñanza media, por lo que una vez egresado no puedes modificarlo. Sin embargo, si realizas un nuevo proceso de admisión después de algunos años, algunas universidades permiten usar un NEM recalculado.</p>
    </div>
  </div>

  <div class="info-section">
    <h2>Enlaces Útiles</h2>
    <div class="useful-links-grid">
      <a href="https://certificados.mineduc.cl/certificados-web/mvc/home/index?landingHome=estudios" target="_blank" class="useful-link">
        Calcula tu NEM Aquí
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
      </a>
      <a href="https://mifuturo.cl/buscador-de-empleabilidad-e-ingresos/" target="_blank" class="useful-link">
        Datos de empleabilidad e ingresos
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
      </a>
      <a href="https://demre.cl/paes/factores-seleccion/tabla-transformacion-nem" target="_blank" class="useful-link">
        Tablas Oficiales de Transformación NEM
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
      </a>
      <a href="https://demre.cl" target="_blank" class="useful-link">
        Sitio Oficial DEMRE
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
      </a>
    </div>
  </div>

  <div class="about-section">
    Página creada con ayuda de IAs, por Hugh - Renato y Cinthia.
  </div>
</div>

<script>
// --- GLOBAL VARIABLES ---
let tablasNEM = {};
let carrerasData = [];

// --- CORE FUNCTIONS ---
async function fetchData() {
  try {
    const [carrerasResponse] = await Promise.all([
      fetch('carreras.json')
    ]);
    if (!carrerasResponse.ok) throw new Error('Error al cargar datos de carreras');
    
    carrerasData = await carrerasResponse.json();
    console.log('Datos de Carreras cargados correctamente');
    
    try {
        const nemResponse = await fetch('tabla_NEM_completa.json');
        if (nemResponse.ok) {
            tablasNEM = await nemResponse.json();
            console.log('Datos de NEM cargados correctamente');
        }
    } catch (e) {
        console.warn("No se pudo cargar el archivo de NEM, la calculadora NEM no funcionará.");
    }

    return true;
  } catch (error) {
    console.error('Error cargando datos:', error);
    carrerasData = [];
    return false;
  }
}

function redondearNota(nota) {
  return Math.round(nota * 100) / 100;
}

// --- NEM CALCULATOR LOGIC ---
function buscarPuntaje(grupo, nota) {
  const tabla = tablasNEM[grupo];
  if (!tabla) return 100;
  const notaRedondeada = redondearNota(nota);
  const notaStr = notaRedondeada.toFixed(2);
  if (tabla[notaStr] !== undefined) return tabla[notaStr];
  const claves = Object.keys(tabla).map(Number).sort((a, b) => a - b);
  for (let i = claves.length - 1; i >= 0; i--) {
    if (claves[i] <= notaRedondeada) return tabla[claves[i].toFixed(2)];
  }
  return 100;
}

function mostrarError(elementoId, mostrar) {
  const elemento = document.getElementById(elementoId);
  if (elemento) elemento.style.display = mostrar ? 'block' : 'none';
}

function validarNota(notaId) {
  const notaInput = document.getElementById(notaId);
  const notaStr = notaInput.value.replace(',', '.');
  const notaNum = parseFloat(notaStr);
  notaInput.classList.remove('valid', 'invalid');
  if (notaStr === '') {
    mostrarError(notaId + '-error', false);
    return null;
  }
  if (isNaN(notaNum) || notaNum < 1 || notaNum > 7) {
    notaInput.classList.add('invalid');
    mostrarError(notaId + '-error', true);
    return null;
  }
  notaInput.classList.add('valid');
  mostrarError(notaId + '-error', false);
  return notaNum;
}

async function calcularNEM() {
  const spinner = document.getElementById('calc-spinner');
  const calcularBtn = document.getElementById('calcular-btn');
  spinner.style.display = 'block';
  calcularBtn.disabled = true;

  setTimeout(() => {
    try {
      const grupo = document.getElementById('grupo').value;
      if (!grupo) {
        mostrarError('grupo-error', true);
        return;
      }
      mostrarError('grupo-error', false);
      const notas = ['nem1', 'nem2', 'nem3', 'nem4'].map(validarNota);
      if (notas.some(n => n === null)) return;

      const promedio = notas.reduce((a, b) => a + b, 0) / notas.length;
      const promedioRedondeado = redondearNota(promedio);
      const puntaje = buscarPuntaje(grupo, promedioRedondeado);

      document.getElementById('show-nem1').textContent = notas[0].toFixed(2).replace('.', ',');
      document.getElementById('show-nem2').textContent = notas[1].toFixed(2).replace('.', ',');
      document.getElementById('show-nem3').textContent = notas[2].toFixed(2).replace('.', ',');
      document.getElementById('show-nem4').textContent = notas[3].toFixed(2).replace('.', ',');
      document.getElementById('promedio-nem').textContent = promedioRedondeado.toFixed(2).replace('.', ',');
      document.getElementById('puntaje-nem').textContent = puntaje;
      
      const resultadoSection = document.getElementById('resultado');
      resultadoSection.style.display = 'block';
      resultadoSection.scrollIntoView({ behavior: 'smooth' });
    } finally {
      spinner.style.display = 'none';
      calcularBtn.disabled = false;
    }
  }, 100);
}

function limpiarFormularioNEM() {
  ['grupo', 'nem1', 'nem2', 'nem3', 'nem4'].forEach(id => {
    const el = document.getElementById(id);
    if(el.tagName === 'SELECT') el.selectedIndex = 0;
    else el.value = '';
    el.classList.remove('valid', 'invalid');
  });
  document.getElementById('resultado').style.display = 'none';
  document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
}

// --- PAES SIMULATOR LOGIC ---
function validarPuntajePAES(inputId) {
    const input = document.getElementById(inputId);
    const value = parseFloat(input.value);

    input.classList.remove('valid', 'invalid');

    if (input.value === '') return;

    if (!isNaN(value) && value >= 100 && value <= 1000) {
        input.classList.add('valid');
    } else {
        input.classList.add('invalid');
    }
}

function setupSimulator() {
    const uniSelect = document.getElementById('universidad');
    const carreraSelect = document.getElementById('carrera');

    const universidades = [...new Set(carrerasData.map(c => c.universidad))].sort();
    
    uniSelect.innerHTML = '<option value="">-- Selecciona una universidad --</option>';
    universidades.forEach(uni => {
        const option = document.createElement('option');
        option.value = uni;
        option.textContent = uni;
        uniSelect.appendChild(option);
    });

    uniSelect.addEventListener('change', () => {
        const selectedUni = uniSelect.value;
        carreraSelect.innerHTML = '<option value="">-- Selecciona una carrera --</option>';
        carreraSelect.disabled = true;
        resetPonderaciones();
        if (!selectedUni) return;

        const carreras = carrerasData
            .filter(c => c.universidad === selectedUni)
            .sort((a, b) => a.carrera.localeCompare(b.carrera));
        
        carreras.forEach((carrera) => {
            const option = document.createElement('option');
            option.value = carrerasData.indexOf(carrera); 
            option.textContent = `${carrera.carrera}${carrera.sede ? ` (${carrera.sede})` : ''}`;
            carreraSelect.appendChild(option);
        });
        carreraSelect.disabled = false;
    });

    carreraSelect.addEventListener('change', () => {
        const index = carreraSelect.value;
        if (index === "") {
            resetPonderaciones();
            return;
        }
        const carrera = carrerasData[index];
        displayPonderaciones(carrera.ponderaciones);
    });
}

function displayPonderaciones(ponderaciones) {
    document.getElementById('w-nem').textContent = `Ponderación: ${ponderaciones.NEM}%`;
    document.getElementById('w-ranking').textContent = `Ponderación: ${ponderaciones.Ranking}%`;
    document.getElementById('w-lectora').textContent = `Ponderación: ${ponderaciones.Lectora}%`;
    document.getElementById('w-m1').textContent = `Ponderación: ${ponderaciones.M1}%`;
    document.getElementById('w-m2').textContent = ponderaciones.M2 > 0 ? `Ponderación: ${ponderaciones.M2}%` : '';
    document.getElementById('w-ciencias').textContent = ponderaciones.Ciencias > 0 ? `Ponderación: ${ponderaciones.Ciencias}%` : '';
    document.getElementById('w-historia').textContent = ponderaciones.Historia > 0 ? `Ponderación: ${ponderaciones.Historia}%` : '';
}

function resetPonderaciones() {
    ['w-nem', 'w-ranking', 'w-lectora', 'w-m1', 'w-m2', 'w-ciencias', 'w-historia'].forEach(id => {
        document.getElementById(id).textContent = '';
    });
}

function simularPuntaje() {
    const spinner = document.getElementById('sim-spinner');
    const simularBtn = document.getElementById('simular-btn');
    spinner.style.display = 'block';
    simularBtn.disabled = true;

    setTimeout(() => {
        try {
            const carreraSelect = document.getElementById('carrera');
            const index = carreraSelect.value;
            if (index === "") {
                alert("Por favor, selecciona una universidad y una carrera.");
                return;
            }

            const carrera = carrerasData[index];
            const p = carrera.ponderaciones;

            const scores = {
                nem: parseFloat(document.getElementById('p-nem').value) || 0,
                ranking: parseFloat(document.getElementById('p-ranking').value) || 0,
                lectora: parseFloat(document.getElementById('p-lectora').value) || 0,
                m1: parseFloat(document.getElementById('p-m1').value) || 0,
                m2: parseFloat(document.getElementById('p-m2').value) || 0,
                ciencias: parseFloat(document.getElementById('p-ciencias').value) || 0,
                historia: parseFloat(document.getElementById('p-historia').value) || 0
            };
            
            let puntajePonderado = 0;
            puntajePonderado += (scores.nem * p.NEM / 100);
            puntajePonderado += (scores.ranking * p.Ranking / 100);
            puntajePonderado += (scores.lectora * p.Lectora / 100);
            puntajePonderado += (scores.m1 * p.M1 / 100);
            puntajePonderado += (scores.m2 * p.M2 / 100);

            if (p.Ciencias > 0 && p.Historia > 0) {
                const puntajeElectiva = Math.max(scores.ciencias, scores.historia);
                puntajePonderado += (puntajeElectiva * p.Ciencias / 100);
            } else {
                puntajePonderado += (scores.ciencias * p.Ciencias / 100);
                puntajePonderado += (scores.historia * p.Historia / 100);
            }

            const corte = carrera.corte_2025;
            const diferencia = puntajePonderado - corte;

            document.getElementById('puntaje-ponderado').textContent = puntajePonderado.toFixed(2);
            document.getElementById('puntaje-corte').textContent = corte.toFixed(2);
            const difEl = document.getElementById('diferencia-puntaje');
            difEl.textContent = `${diferencia >= 0 ? '+' : ''}${diferencia.toFixed(2)} puntos`;
            difEl.className = `diferencia ${diferencia >= 0 ? 'positiva' : 'negativa'}`;

            const resultadoSection = document.getElementById('resultado-simulador');
            resultadoSection.style.display = 'block';
            resultadoSection.scrollIntoView({ behavior: 'smooth' });

        } finally {
            spinner.style.display = 'none';
            simularBtn.disabled = false;
        }
    }, 100);
}

// --- TAB SWITCHING LOGIC ---
function setupMainTabs() {
  const tabButtons = document.querySelectorAll('.main-tab-button');
  const tabContents = document.querySelectorAll('.main-tab-content');
  
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      
      button.classList.add('active');
      const tabId = button.getAttribute('data-tab');
      document.getElementById(tabId).classList.add('active');
    });
  });
}

// --- DOMContentLoaded EVENT LISTENER ---
document.addEventListener('DOMContentLoaded', async function() {
  const dataLoaded = await fetchData();
  
  if (dataLoaded) {
    setupSimulator();
  } else {
    document.getElementById('universidad').innerHTML = '<option value="">Error al cargar datos</option>';
  }

  setupMainTabs();
  
  document.getElementById('calcular-btn').addEventListener('click', calcularNEM);
  document.getElementById('limpiar-btn').addEventListener('click', limpiarFormularioNEM);
  document.getElementById('simular-btn').addEventListener('click', simularPuntaje);
  
  document.querySelectorAll('#calculadora-nem input').forEach(input => {
    input.addEventListener('keypress', e => { if (e.key === 'Enter') calcularNEM(); });
    input.addEventListener('input', () => validarNota(input.id));
  });
  
  document.getElementById('grupo').addEventListener('change', function() {
    if (this.value) mostrarError('grupo-error', false);
  });
  
  const puntajeInputs = ['p-nem', 'p-ranking', 'p-lectora', 'p-m1', 'p-m2', 'p-ciencias', 'p-historia'];
  puntajeInputs.forEach(inputId => {
    const inputElement = document.getElementById(inputId);
    inputElement.addEventListener('input', () => validarPuntajePAES(inputId));
    inputElement.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        simularPuntaje();
      }
    });
  });
});
</script>

</body>
</html>
